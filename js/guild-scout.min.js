var bh;(function(e){var t;(function(t){var n;(function(n){function i(t){var n=t.data;e.data.guilds.put(n.playerGuild.id,n.playerGuild.name),e.data.reports.putGuild(n),l(n.playerGuild.id,n.playerGuild.name)}function r(t){var n=t.data;n.forEach(function(t){return e.data.guilds.put(t.id,t.name)})}function a(t){var n=t.data,i=e.data.guilds.findNameByGuid(n[0].guildId);e.data.reports.putGuildMembers(n),i&&l(i.guid,i.name)}function d(t){var n=e.data.guilds.findNameByGuid(t.guildGuid);n&&l(n.guid,n.name)}function s(t){var n=t.data;n.guilds.forEach(function(t){return e.data.guilds.put(t.id,t.name)}),e.data.reports.putGuildWar(n),n.guilds.forEach(function(e){return l(e.id,e.name)})}function u(t){var n=t.data;e.data.guilds.updateLeaderBoard(n),o()}function l(t,n){var i=e.$("#brain-hud-scouter-guild-target");!i.length,i.find('option[value="'+t+'"]').length||(i.append('<option value="'+t+'">'+n+"</option>"),i.children().toArray().slice(1).sort(function(e,t){return e.text<t.text?-1:e.text==t.text?0:1}).forEach(function(e){return i.append(e)})),e.$("div.brain-hud-scouter-guild-container").addClass("active"),i.val(t),c()}function o(){e.$("#brain-hud-scouter-guild-target").children().toArray().forEach(g)}function g(t){if(t&&t.value){var n=t.value,i=e.data.guilds.findNameByGuid(n),r=e.data.players.filterByGuildGuid(n),a=r.map(function(e){return e.powerRating}).reduce(function(e,t){return e+t},0)||0,d=a?" ("+e.utils.formatNumber(a)+")":"",s=i&&i.leaderBoardEntry||null,u=s?"#"+(s.rank+1)+" ":"",l=s&&(s.wins||s.losses)?"("+i.leaderBoardEntry.wins+"/"+i.leaderBoardEntry.losses+") ":"",o=""+u+l+i.name+d;t.text=o}}function c(){var t=e.$("#brain-hud-scouter-guild-target").val();g(e.$('#brain-hud-scouter-guild-target > option[value="'+t+'"]')[0]),e.$("#brain-hud-scouter-guild-report").val(e.data.reports.getReport(t)[t]||"")}function v(t,n){var i="https://battlehand-game-kong.anotherplacegames.com/v1/guild/getguilds?player="+e.Messenger.ActivePlayerGuid+"&sessionKey="+e.Messenger.ActiveSessionKey+"&name="+t+"&joinableonly=False&language=&minfamelevel=2&maxfamelevel=44";return new Promise(function(t,r){return e.Messenger.ActivePlayerGuid&&e.Messenger.ActiveSessionKey?void XmlHttpRequest.getJSON(i).then(function(e){return e&&Array.isArray(e)?void f(e,n).then(t,r):r("invalid json")},r):r("not initialized")})}function f(e,n){return new Promise(function(i,r){function a(){(d=s.shift())?setTimeout(function(){return m(d.id,n).then(a,a)},t._delayMS):i()}var d,s=e.slice();a()})}function m(n,i){var r="https://battlehand-game-kong.anotherplacegames.com/v1/guild/getmembers?player="+e.Messenger.ActivePlayerGuid+"&sessionKey="+e.Messenger.ActiveSessionKey+"&guild="+n;return e.isLocal&&(r="./json/"+n+".json"),new Promise(function(a,d){return e.Messenger.ActivePlayerGuid&&e.Messenger.ActiveSessionKey?n?void XmlHttpRequest.getJSON(r).then(function(n){if(!n||!Array.isArray(n))return d("invalid json");if(e.Messenger.instance.postMessage(e.Messenger.createMessage("get-guild-members",n)),i){var r=n.map(function(e){return e.playerId});t.player.playersGet(r).then(a,a)}else a(n)},d):d("no guild id"):d("not initialized")})}function p(t,n){void 0===t&&(t=0),void 0===n&&(n=13);var i="https://battlehand-game-kong.anotherplacegames.com/v1/guildwars/getrange?player="+e.Messenger.ActivePlayerGuid+"&sessionKey="+e.Messenger.ActiveSessionKey+"&start="+t+"&count="+n;return e.isLocal&&(i="./json/top_guilds.json"),new Promise(function(t,n){return e.Messenger.ActivePlayerGuid&&e.Messenger.ActiveSessionKey?void XmlHttpRequest.getJSON(i).then(function(i){return i&&i.leaderboardEntries?(e.Messenger.instance.postMessage(e.Messenger.createMessage("get-leaderboard",i)),void t(i)):n("invalid json")},n):n("not initialized")})}n.addGuildReport=l,n.selectGuildReport=c,t.listener.addAction("get-guild","/v1/guild/get?",i),t.listener.addAction("get-guild-members","/v1/guild/getmembers?",a),t.listener.addAction("get-guild-war","/v1/guildwars/get?",s),t.listener.addAction("get-leaderboard","/v1/guildwars/getrange?",u),t.listener.addAction("get-guildsearch","/v1/guild/getguilds?",r),t.listener.addAction("get-leaderboard-members","/v1/guildwars/getguildmembersrange?",d),n.searchGuilds=v,n.guildsGetMembers=f,n.guildGetMembers=m,n.leaderBoardGet=p,t.listener.addAction("refresh-guild",null,function(e){m(e.data,!0)})})(n=t.guild||(t.guild={}))})(t=e.hud||(e.hud={}))})(bh||(bh={}));